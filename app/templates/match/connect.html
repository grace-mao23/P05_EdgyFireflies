{% extends "base.html" %}

{% block title %}Read and Chill | Chat{% endblock %}

{% block navigation %}
<ul class="navbar-nav ml-auto">
  <li class="nav-item">
    <a class="nav-link text-muted" href="{{ url_for('books.home') }}">Home</a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-muted" href="{{ url_for('auth.settings') }}">Settings</a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-muted" href="{{ url_for('auth.logout') }}">Sign out</a>
  </li>
</ul>
{% endblock %}

{% block content %}
{{ super() }}
{{room}}
<a href="{{ url_for('books.home') }}" onclick="leave()">Leave</a>
<ul id="messages"></ul>
<form action="#" method="POST">
  <input id="m" autocomplete="off" /><button>Send</button>
</form>
{% endblock %}

{% block morescripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
<script type="text/javascript" charset="utf-8">
  $(function () {
    const socket = io(`http://${document.domain}:${location.port}/match/connect`);

    console.log(socket);

    socket.on("connect", function () {
      console.log("connected");
      socket.emit("join", {
        other_user_id: "{{ other_user_id }}"
      });
    });

    socket.on("status", function ({ data }) {
      console.log(data);
      $("#messages").append($("<li>").text(data));
      $("#messages").scrollTop($("#messages")[0].scrollHeight);
    });

    socket.on("response", function ({ data }) {
      console.log(data);
      $("#messages").append($("<li>").text(data));
      $("#messages").scrollTop($("#messages")[0].scrollHeight);
    });

    $("form").submit(function (e) {
      e.preventDefault();
      console.log("sent");
      socket.emit("request", { other_user_id: "{{ other_user_id }}", data: $("#m").val() });
      $("#m").val("");
      return false;
    });

    function leave() {
      console.log("left");
      socket.emit("leave", {}, function () {
        socket.disconnect();
      });
    };
  });
</script>
{% endblock %}